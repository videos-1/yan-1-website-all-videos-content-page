<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Inline Video Queue</title>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%,#071827 100%);
  color:var(--soft);
  font-family:Arial,Helvetica,sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* ----------  Top bar (sticky, flexible) ---------- */
.top-bar{
  position:sticky;
  top:0;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  padding:8px;
  background:var(--card);
  z-index:100;
  box-shadow:0 2px 6px rgba(0,0,0,.5);
}

/* back button (only shown after a search) */
.back-btn{
  display:none;
  padding:6px 12px;
  border-radius:6px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  flex-shrink:0;
}
.back-btn:hover{
  background:var(--accent);
  color:#000;
}

/* -----------  Search section (input + search button) ------------- */
.search-section{
  flex:1;
  display:flex;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  overflow:hidden;
}
.search-section input{
  flex:1;
  border:none;
  padding:6px 10px;
  background:transparent;
  color:var(--soft);
  font-size:14px;
}
.search-section input::placeholder{
  color:#777;
}
.search-section button{
  flex:none;
  padding:6px 12px;
  border:none;
  background:rgba(255,255,255,0.08);
  color:var(--soft);
  font-size:14px;
  cursor:pointer;
}
.search-section button:hover{
  background:var(--accent);
  color:#000;
}
.search-section button:not(:first-of-type){
  border-left:1px solid rgba(255,255,255,0.2);
}

/* upload button (same height as the search bar) */
#uploadBtn{
  padding:6px 12px;
  border-radius:6px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  flex-shrink:0;
}
#uploadBtn:hover{
  background:var(--accent);
  color:#000;
}

/* -----------  Mode toggle (arrow + dropdown) ------------- */
.mode-toggle{
  position:relative;
  align-self:flex-start;               /* left‚Äëalign on wide screens */
}
.mode-arrow{
  font-size:1.2rem;
  font-weight:600;
  color:#fff;
  cursor:pointer;
  user-select:none;
}
.mode-menu{
  position:absolute;
  top:100%;
  left:0;
  margin-top:4px;
  min-width:120px;
  background:var(--card);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:8px;
  padding:8px 0;
  z-index:1000;
}
.mode-item{
  width:100%;
  text-align:left;
  background:none;
  border:none;
  padding:4px 12px;
  color:var(--soft);
  cursor:pointer;
}
.mode-item:hover{
  background:var(--accent);
  color:#000;
}
.mode-close{
  position:absolute;
  top:4px;
  right:6px;
  background:none;
  border:none;
  color:#ff5555;
  font-weight:600;
  font-size:1rem;
  cursor:pointer;
}

/* ----------  Queue ---------- */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:.15s,opacity .3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,.3);
}
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  background-size:cover;
  background-position:center;
}
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft);margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none}
.q-link a:hover{text-decoration:underline}

/* Share button */
.share-btn{
  margin-top:6px;
  padding:4px 8px;
  font-size:12px;
  border-radius:6px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
}
.share-btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader / end‚Äëmessage */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* ----------  Upload overlay ---------- */
.upload-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  display:flex;
  flex-direction:column;
  z-index:2000;
}
.upload-header{
  display:flex;
  justify-content:flex-end;
  padding:8px;
}
.upload-header .close-btn{
  background:rgba(255,255,255,0.2);
  border:none;
  border-radius:4px;
  padding:4px 8px;
  font-size:14px;
  cursor:pointer;
  color:var(--soft);
}
.upload-header .close-btn:hover{
  background:var(--accent);
  color:#000;
}
.upload-iframe{
  flex:1;
  border:none;
}
.hidden{display:none;}

/* -------  Responsive tweaks  ------- */
@media (max-width:640px){
  .search-section{ flex-basis:100%; }
  .mode-toggle{ flex-basis:100%; margin-top:4px; }
  iframe{height:350px !important;}
  h1{font-size:1.8rem}
  h2{font-size:1.25rem}
}
</style>
</head>

<body>

<!-- Persistent top bar -->
<div class="top-bar">
  <button id="backBtn" class="back-btn">‚Üê Back</button>

  <div class="search-section">
    <input type="text" id="searchInput" placeholder="Search by title...">
    <button id="searchBtn">Search</button>
  </div>

  <button id="uploadBtn">Upload</button>

  <div class="mode-toggle">
    <span id="modeArrow" class="mode-arrow">--&gt;</span>
    <div id="modeMenu" class="mode-menu hidden">
      <button class="mode-item" data-mode="id">ID</button>
      <button class="mode-item" data-mode="username">Username</button>
      <button id="closeModeMenu" class="mode-close">‚úñ</button>
    </div>
  </div>
</div>

<!-- Queue -->
<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<!-- Upload overlay (full‚Äëscreen) -->
<div id="uploadOverlay" class="upload-overlay hidden">
  <div class="upload-header">
    <button id="closeUploadBtn" class="close-btn">‚úñ</button>
  </div>
  <iframe src="videos_uploading.html" class="upload-iframe"></iframe>
</div>

<script>
/* --------------------------------------------------------------
   Constants & helpers
   -------------------------------------------------------------- */
const BACKEND     = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';
const BATCH_SIZE  = 30;
const SHARE_BASE  = 'https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/all-videos-content-page-shared-links-redirecting.html';

function getStoredIds(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : [];
  }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(!ids.length) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent analytics IDs:',ids);
    clearStored();
  }catch(e){
    console.error('Failed to send analytics IDs',e);
  }
}

/* --------------------------------------------------------------
   Global state & DOM refs
   -------------------------------------------------------------- */
const queueList   = document.getElementById('queueList');
const loader      = document.getElementById('loader');

let allVideos       = [];   // full catalog
let currentVideos   = [];   // filtered / displayed list
let displayedCount  = 0;    // # rendered items
let currentIndex    = -1;   // playing video index
let searchMode      = 'title'; // default mode

const searchInput   = document.getElementById('searchInput');
const searchBtn     = document.getElementById('searchBtn');
const backBtn       = document.getElementById('backBtn');
const uploadBtn     = document.getElementById('uploadBtn');
const uploadOverlay = document.getElementById('uploadOverlay');
const closeUploadBtn= document.getElementById('closeUploadBtn');
const modeArrow     = document.getElementById('modeArrow');
const modeMenu      = document.getElementById('modeMenu');

/* --------------------------------------------------------------
   Helper: update placeholder according to mode
   -------------------------------------------------------------- */
function updatePlaceholder(){
  if(searchMode==='title'){
    searchInput.placeholder = 'Search by title...';
  }else if(searchMode==='id'){
    searchInput.placeholder = 'Enter ID';
  }else if(searchMode==='username'){
    searchInput.placeholder = 'Enter username';
  }
}

/* --------------------------------------------------------------
   Load videos (once)
   -------------------------------------------------------------- */
async function loadVideos(){
  loader.textContent = 'Fetching videos...';
  try{
    const res = await fetch(BACKEND);
    allVideos     = await res.json();
    currentVideos = allVideos;
    loader.remove();
    renderNextBatch();

    // direct‚Äëlink support ?video_id=‚Ä¶
    const urlParams = new URLSearchParams(window.location.search);
    const videoId   = urlParams.get('video_id');
    if(videoId){
      const targetIdx = allVideos.findIndex(v=>String(v.id)===videoId);
      if(targetIdx !== -1){
        renderBatchesUpTo(targetIdx);
        setTimeout(()=>playInline(targetIdx),0);
      }
    }
  }catch{
    loader.textContent = '‚ùå Failed to load videos from backend';
  }
}

/* --------------------------------------------------------------
   Rendering
   -------------------------------------------------------------- */
function renderBatchesUpTo(idx){
  while(displayedCount <= idx && displayedCount < currentVideos.length){
    renderNextBatch();
  }
}
function renderNextBatch(){
  const batch = currentVideos.slice(displayedCount, displayedCount + BATCH_SIZE);
  batch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absIdx = displayedCount + i;
    card.dataset.idx = absIdx;

    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')" data-bg="${v.archive_org_iframe_image_link||""}"></div>
      <div class="q-title">${v.title||'Untitled'}</div>
      <div class="q-sub">By ${v.username||'Unknown'}</div>
      <div class="q-id">ID: ${v.id||'?'}</div>
      <div class="q-link">Link‚ÄØ1: <a href="${v.link_1}" target="_blank">${v.link_1||'No link'}</a></div>
      <div class="q-link">Link‚ÄØ2: <a href="${v.link_2}" target="_blank">${v.link_2||'No link'}</a></div>
      <button class="share-btn">Share</button>
    `;

    // play on whole‚Äëcard click
    card.onclick = () => playInline(absIdx);

    // share button (independent)
    const shareBtn = card.querySelector('.share-btn');
    shareBtn.addEventListener('click', e => {
      e.stopPropagation();
      shareVideo(v);
    });

    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });
  displayedCount += batch.length;

  // end‚Äëof‚Äëlist message
  if(displayedCount >= currentVideos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = 'üéâ All videos loaded';
    queueList.appendChild(endMsg);
  }
}

/* --------------------------------------------------------------
   Infinite scroll
   -------------------------------------------------------------- */
queueList.addEventListener('scroll',()=>{
  const nearBottom = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight - 150;
  if(nearBottom && displayedCount < currentVideos.length){
    renderNextBatch();
  }
});

/* --------------------------------------------------------------
   Play video inline
   -------------------------------------------------------------- */
function playInline(idx){
  currentIndex = idx;
  const video = currentVideos[idx];
  const items = document.querySelectorAll('.queue-item');

  items.forEach(item=>{
    const itemIdx = Number(item.dataset.idx);
    const isActive = itemIdx===idx;
    item.classList.toggle('active', isActive);
    const thumb = item.querySelector('.thumb');

    if(isActive){
      thumb.style.backgroundImage = '';
      thumb.innerHTML = `<video controls controlslist="nodownload" autoplay playsinline style="width:100%;height:100%" src="${video.mp4_link}" poster="${video.archive_org_iframe_image_link}"></video>`;
    }else{
      thumb.innerHTML = '';
      const bg = thumb.dataset.bg;
      thumb.style.backgroundImage = bg ? `url('${bg}')` : '';
    }
  });

  const activeItem = queueList.querySelector('.queue-item[data-idx="'+idx+'"]');
  activeItem?.scrollIntoView({behavior:'smooth',block:'center'});

  if(video.id!=null) store(Number(video.id));
}

/* --------------------------------------------------------------
   Share helpers
   -------------------------------------------------------------- */
function shareVideo(video){
  const link = `${SHARE_BASE}?video_id=${encodeURIComponent(video.id)}`;
  if(navigator.share){
    navigator.share({
      title: video.title || 'Video',
      url:   link
    }).catch(()=>copyToClipboard(link));
  }else{
    copyToClipboard(link);
  }
}
function copyToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text)
      .then(()=>alert('Share link copied to clipboard!'))
      .catch(()=>fallbackCopy(text));
  }else{
    fallbackCopy(text);
  }
}
function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  document.body.appendChild(ta);
  ta.select();
  try{ document.execCommand('copy'); alert('Share link copied to clipboard!'); }
  catch{ prompt('Copy the link manually:', text); }
  document.body.removeChild(ta);
}

/* --------------------------------------------------------------
   Search handling (single bar, mode‚Äëswitchable)
   -------------------------------------------------------------- */
function performSearch(){
  const query = searchInput.value.trim();
  if(!query){
    backToAllVideos();
    return;
  }

  let filtered = [];
  if(searchMode==='title'){
    const q = query.toLowerCase();
    filtered = allVideos.filter(v => (v.title||'').toLowerCase().includes(q));
  }else if(searchMode==='id'){
    filtered = allVideos.filter(v => String(v.id) === query);
  }else if(searchMode==='username'){
    const q = query.toLowerCase();
    filtered = allVideos.filter(v => (v.username||'').toLowerCase().includes(q));
  }

  currentVideos  = filtered;
  displayedCount = 0;
  queueList.innerHTML = '';
  queueList.scrollTop = 0;

  if(filtered.length===0){
    const msg = document.createElement('div');
    msg.className = 'loader';
    msg.textContent = 'No videos found.';
    queueList.appendChild(msg);
  }else{
    renderNextBatch();
  }
  backBtn.style.display = 'inline-block';
}

/* --------------------------------------------------------------
   Back to full list
   -------------------------------------------------------------- */
function backToAllVideos(){
  searchMode = 'title';
  updatePlaceholder();
  currentVideos  = allVideos;
  displayedCount = 0;
  queueList.innerHTML = '';
  queueList.scrollTop = 0;
  renderNextBatch();

  backBtn.style.display = 'none';
  searchInput.value = '';
}

/* --------------------------------------------------------------
   Mode‚Äëmenu handling
   -------------------------------------------------------------- */
modeArrow.addEventListener('click',()=>{ modeMenu.classList.toggle('hidden'); });

document.querySelectorAll('.mode-item').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const mode = e.target.dataset.mode;
    if(mode){ searchMode = mode; updatePlaceholder(); }
    modeMenu.classList.add('hidden');
  });
});
document.getElementById('closeModeMenu').addEventListener('click',()=>modeMenu.classList.add('hidden'));

/* --------------------------------------------------------------
   Upload overlay controls
   -------------------------------------------------------------- */
uploadBtn.addEventListener('click',()=>uploadOverlay.classList.remove('hidden'));
closeUploadBtn.addEventListener('click',()=>uploadOverlay.classList.add('hidden'));

/* --------------------------------------------------------------
   UI listeners
   -------------------------------------------------------------- */
searchBtn.addEventListener('click',performSearch);
searchInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){ e.preventDefault(); performSearch(); }
});
backBtn.addEventListener('click',backToAllVideos);

/* --------------------------------------------------------------
   Initialise app
   -------------------------------------------------------------- */
window.addEventListener('load', async()=>{
  await sendStoredToBackend();
  await loadVideos();
});
</script>

</body>
</html>
