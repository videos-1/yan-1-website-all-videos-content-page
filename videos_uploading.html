<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Archive Video Uploader</title>
  <style>
    :root {
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#60a5fa;
      --muted:#94a3b8;
      --text:#e6eef8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,Arial,sans-serif;
      background:linear-gradient(180deg,#071024 0%,#07172a 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:100%;
      max-width:900px;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:16px;
      padding:20px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:none;
      background:rgba(255,255,255,0.03);
      color:var(--text);
      cursor:pointer;
      transition:0.2s;
    }
    .btn:hover{background:rgba(255,255,255,0.08)}
    .primary{background:var(--accent);color:#062235}
    .small{font-size:13px;color:var(--muted)}
    .page{display:none;margin-top:18px}
    .page.active{display:block}
    input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{min-height:80px;resize:vertical}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .error{color:#ff8b8b;font-weight:600}
    .notice{
      background:rgba(255,255,255,0.05);
      border:1px solid var(--accent);
      padding:10px;
      border-radius:8px;
      font-weight:600;
      margin-bottom:12px;
    }
    .preview{margin-top:12px;border-radius:10px;overflow:hidden;background:#000}
    video{
      width:100%;
      height:auto;
      display:block;
      border-radius:10px;
      pointer-events:auto;
    }
    video::-webkit-media-controls-enclosure{overflow:hidden}
    video::-webkit-media-controls-download-button,
    video::-internal-media-controls-download-button{display:none !important}
    video[controlslist]{controlslist:nodownload}
    @media (max-width:768px){
      body{padding:12px}
      .app{padding:16px}
      .row-2{grid-template-columns:1fr}
    }
    /* Share button (kept for potential future use) */
    .share-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin-left:8px;
      padding:4px 8px;
      font-size:13px;
      font-weight:600;
      color:#000;
      background:var(--accent);
      border:none;
      border-radius:6px;
      cursor:pointer;
      transition:background .2s;
    }
    .share-btn:hover{
      background:#4ecbff;
    }
  </style>
</head>

<body>
  <main class="app" role="main">

    <header>
      <button id="openUpload" class="btn primary" style="min-width:120px;">Upload</button>
    </header>

    <section class="view">
      <div class="notice">
        Click <strong>Upload</strong> to open the uploader form. All fields are mandatory.
      </div>

      <!-- Upload Form -->
      <div id="uploadPage" class="page">
        <h3 style="margin-top:16px;margin-bottom:10px">Upload to Archive</h3>
        <form id="uploadForm" novalidate>
          <label>Archive.org iframe / URL</label>
          <textarea id="archiveVideo" placeholder="Paste full iframe or archive.org URL"></textarea>

          <label>Archive.org image link</label>
          <input id="archiveImage" type="text" placeholder="https://archive.org/...jpg" />

          <label>Title</label>
          <input id="title" type="text" placeholder="Video title" />

          <div class="row-2">
            <div>
              <label>Link 1</label>
              <input id="link1" type="text" placeholder="Any link 1" />
            </div>
            <div>
              <label>Link 2</label>
              <input id="link2" type="text" placeholder="Any link 2" />
            </div>
          </div>

          <div class="row-2">
            <div>
              <label>Username</label>
              <input id="username" type="text" placeholder="Uploader username" />
            </div>
            <div>
              <label>Phone number</label>
              <input id="phone" type="tel" placeholder="Phone number" />
            </div>
          </div>

          <div class="meta small">All fields required. We'll auto‑generate MP4 link.</div>

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button id="previewBtn" type="button" class="btn">Preview MP4</button>
            <button id="postBtn" type="submit" class="btn primary">Post</button>
            <div id="formStatus" class="small" style="margin-left:8px;min-height:18px"></div>
          </div>

          <div id="previewArea" class="preview" style="display:none;margin-top:12px">
            <video id="previewVideo" controls playsinline controlslist="nodownload"></video>
          </div>
        </form>
      </div>

    </section>
  </main>

  <script>
    /* -------------------- Constants -------------------- */
    const BACKEND_UPLOAD = 'https://free_videos_metadata_backend.ajaia-backend.workers.dev/upload';
    const STORAGE_KEY    = 'watched_videos';

    /* -------------------- Helper Functions -------------------- */
    function extractArchiveId(input) {
      if (!input) return null;
      const iframeMatch = input.match(/src\s*=\s*"([^"]+)"/i);
      const url = iframeMatch ? iframeMatch[1] : input.trim();
      const clean = url.split('?')[0];
      const patterns = [
        /archive\.org\/embed\/([^\/\?\s]+)/i,
        /archive\.org\/details\/([^\/\?\s]+)/i,
        /archive\.org\/download\/([^\/\?\s]+)/i
      ];
      for (const p of patterns) {
        const m = clean.match(p);
        if (m && m[1]) return decodeURIComponent(m[1]);
      }
      return null;
    }

    async function getMp4FromMetadata(id) {
      const res = await fetch(`https://archive.org/metadata/${id}`);
      if (!res.ok) throw new Error('Metadata not found');
      const data = await res.json();
      const file = data?.files?.find(f => f.name.toLowerCase().endsWith('.mp4'));
      if (!file) throw new Error('No MP4 found');
      return `https://archive.org/download/${id}/${encodeURIComponent(file.name)}`;
    }

    function storeVideoId(id) {
      if (!id) return;
      let ids = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        ids = raw ? JSON.parse(raw) : [];
      } catch {}
      if (!ids.includes(id)) {
        ids.push(id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
        console.log('Stored video ID:', id);
      }
    }

    /* -------------------- UI Interactions -------------------- */
    // Open / close upload form
    document.getElementById('openUpload').addEventListener('click', () => {
      document.getElementById('uploadPage').classList.toggle('active');
      // scroll to bottom for better UX
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    // Preview MP4 button
    document.getElementById('previewBtn').addEventListener('click', async () => {
      const id = extractArchiveId(document.getElementById('archiveVideo').value);
      const status = document.getElementById('formStatus');
      if (!id) return (status.innerHTML = '<span class="error">Invalid Archive.org link</span>');
      try {
        const mp4 = await getMp4FromMetadata(id);
        document.getElementById('previewVideo').src = mp4;
        document.getElementById('previewArea').style.display = 'block';
        status.textContent = 'Preview ready ✔️';
      } catch (err) {
        status.innerHTML = `<span class="error">${err.message}</span>`;
      }
    });

    // Upload form submission
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('formStatus');

      const archiveVideo = document.getElementById('archiveVideo').value.trim();
      const archiveImage = document.getElementById('archiveImage').value.trim();
      const title        = document.getElementById('title').value.trim();
      const link1        = document.getElementById('link1').value.trim();
      const link2        = document.getElementById('link2').value.trim();
      const username     = document.getElementById('username').value.trim();
      const phone        = document.getElementById('phone').value.trim();

      if (![archiveVideo, archiveImage, title, link1, link2, username, phone].every(Boolean)) {
        return (status.innerHTML = '<span class="error">All fields required.</span>');
      }

      if (!/^https?:\/\/(www\.)?archive\.org\//i.test(archiveImage)) {
        return (status.innerHTML = '<span class="error">Image link must be from archive.org</span>');
      }

      const id = extractArchiveId(archiveVideo);
      if (!id) return (status.innerHTML = '<span class="error">Invalid archive link.</span>');

      try {
        status.textContent = 'Fetching MP4...';
        const mp4_link = await getMp4FromMetadata(id);
        const payload = {
          mp4_link,
          archive_org_iframe_image_link: archiveImage,
          title,
          link_1: link1,
          link_2: link2,
          username,
          phone_number: phone
        };
        const res = await fetch(BACKEND_UPLOAD, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) status.innerHTML = '<strong>✅ Uploaded successfully!</strong>';
        else status.innerHTML = `<span class="error">Upload failed: ${res.status}</span>`;
      } catch (err) {
        status.innerHTML = `<span class="error">${err.message}</span>`;
      }
    });

    // Global listener – store video ID for any video that starts playing (fallback)
    document.addEventListener(
      'play',
      e => {
        if (e.target && e.target.tagName === 'VIDEO') {
          const vid = e.target.getAttribute('data-video-id') || e.target.src || null;
          if (vid) storeVideoId(vid);
        }
      },
      true
    );
  </script>
</body>
</html>
